<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kids Todo Music Box</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous">
        </script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"
        integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>
</head>

<body>
    <div class="container--fluid p-4 mx-auto">
        <header class="d-flex justify-content-between align-items-center pb-3 mb-5 border-bottom">
            <div class="d-flex align-items-center">
                <a href="/" class="text-dark text-decoration-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor"
                        class="bi bi-boombox me-5" viewBox="0 0 16 16">
                        <path
                            d="M2.5 5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Zm2 0a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Zm7.5-.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Zm1.5.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Zm-7-1a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3Zm5.5 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Z" />
                        <path
                            d="M11.5 13a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Zm0-1a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3ZM5 10.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Z" />
                        <path
                            d="M7 10.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0Zm-1 0a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0Z" />
                        <path
                            d="M14 0a.5.5 0 0 1 .5.5V2h.5a1 1 0 0 1 1 1v11a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h12.5V.5A.5.5 0 0 1 14 0ZM1 3v3h14V3H1Zm14 4H1v7h14V7Z" />
                    </svg>
                </a>
                <h1 class="fs-4; me-3">Kids Todo Music Box</h1>
            </div>
            <div class="d-flex align-items-center">
                <div class="h4 mx-3">

                </div>
                <h4>Punkte:</h4>
                <div id="point" class="h4 mx-3">0</div>
                <h4>Total:</h4>
                <div id="total-point" class="text-danger h4 mx-3">0</div>
                <div class="h4 ms-3">
                    <div class="btn-group">
                        <button id="restart" title="Restart" type="button" class="btn btn-outline-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"></path>
                                <path
                                    d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z">
                                </path>
                            </svg>
                        </button>
                        <button id="settings" title="Settings" type="button" class="btn btn-outline-secondary"
                            --data-bs-toggle="modal" --data-bs-target="#settingsModal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-gear-fill" viewBox="0 0 16 16">
                                <path
                                    d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="settingsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
                aria-labelledby="settingsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-fullscreen">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="settingsModalLabel">Tasks bearbeiten</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="container-fluid" id="settingsContainer">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="update-settings">Save changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main id="musicbox" class="container-fluid">

        </main>
        <footer class="pt-5 my-5 text-muted border-top">
            2023 © Moers
        </footer>
    </div>

    <template id="player">
        <div class="timer">
            <div class="row align-items-center mb-2">
                <div class="col-sm-2 time text-center">
                    01:59
                </div>
                <div class="col-sm-5 fs-1 text">Zähne putzen</div>
                <div class="col-sm-5 text-end">
                    <button type="submit" class="btn btn-primary me-3">Starten</button>
                </div>
            </div>
            <div class="row mb-5">
                <div class="col-sm-12">
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                            role="progressbar" aria-label="Success example" style="width: 0%;" aria-valuenow="25"
                            aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="settingsTemplate">
        <div class="setting row g-sm-1 g-md-2">
            <div class="col-sm-3 col-lg-2">
                <label for="duration-group" class="form-label">Dauer</label>
                <div class="input-group mb-3" id="duration-group">
                    <div class="input-group-text">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-grip-vertical" viewBox="0 0 16 16">
                            <path
                                d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z" />
                        </svg>
                    </div>
                    <input type="text" class="form-control text-end" id="min" placeholder="00" min="0"
                        inputmode="numeric" pattern="\d*">
                    <span class="px-1 input-group-text">:</span>
                    <input type="text" class="form-control" id="sec" placeholder="00" min="0" inputmode="numeric"
                        pattern="\d*">
                </div>
            </div>
            <div class="col-sm-3 col-lg-5">
                <label for="title" class="form-label">Aufgabe</label>
                <input type="text" class="form-control" id="title">
            </div>
            <div class="col-sm-2 col-lg-1">
                <label for="type" class="form-label">Typ</label>
                <select class="form-select" id="type">
                    <option value="down">zügig</option>
                    <option value="up">gründlich</option>
                </select>
            </div>
            <div class="col-sm-2 col-lg-2">
                <label for="track" class="form-label">Track</label>
                <div class="input-group">
                    <select class="form-select" id="track">
                    </select>
                    <div class="input-group-text" id="btnGroupAddon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" id="play"
                            class="bi bi-play-circle-fill" viewBox="0 0 16 16">
                            <path
                                d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z" />
                        </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-sm-2 col-lg-2">
                <label for="rem" class="form-label">Status</label>
                <select class="form-select" id="state">
                    <option value="on">ein</option>
                    <option value="off">aus</option>
                </select>
            </div>
        </div>
    </template>
    <script>
        const sounds = {
            '1': {
                name: 'Midnight Ride',
                file: 'midnight-ride-01a.mp3',
            },
            '2': {
                name: 'Barn Beat',
                file: 'barn-beat-01.mp3',
            },
            '3': {
                name: 'Cautious Path',
                file: 'cautious-path-01.mp3',
            },
            '4': {
                name: 'Jungle Run',
                file: 'jungle-run-01.mp3',
            },
            '5': {
                name: 'Destination',
                file: 'destination-01.mp3',
            },
            '6': {
                name: 'Heart of the Sea',
                file: 'heart-of-the-sea-01.mp3',
            },
            '7': {
                name: 'Iron Man',
                file: 'iron-man-01.mp3'
            }
        };

        const timerTemplate = {
            direction: 'up',
            trackID: 1,
            time: '02:00',
            title: '',
            progress: 0
        }

        const config = {
            point: 0,
            totalPoint: 0,
            isPlaying: false
        }

        const getTrack = function (trackID) {
            const track = sounds[trackID] || sounds[1];
            return `/sounds/${track.file}`;
        }

        const getTimers = function () {
            const tracks = localStorage.getItem("timers");
            if (tracks) {
                return JSON.parse(tracks);
            }
            return [{
                direction: 'up',
                trackID: '1',
                min: 2,
                sec: 0,
                title: 'Zähne putzen',
                enabled: true
            },
            {
                direction: 'down',
                trackID: '2',
                min: 6,
                sec: 0,
                title: 'Duschen',
                enabled: true
            },
            {
                direction: 'down',
                trackID: '3',
                min: 1,
                sec: 0,
                title: 'Haare bürsten',
                enabled: true
            },
            {
                direction: 'down',
                trackID: '4',
                min: 1,
                sec: 0,
                title: 'Pyjama anziehen',
                enabled: true
            },
            {
                direction: 'down',
                trackID: '5',
                min: 0,
                sec: 30,
                title: 'Gesicht eincremen',
                enabled: true
            },
            {
                direction: 'down',
                trackID: '5',
                min: 1,
                sec: 00,
                title: 'Yoga',
                enabled: false
            }
            ];
        }

        const setTimers = function (timers) {
            localStorage.setItem("timers", JSON.stringify(timers));
        }

        const timerTask = function (timer) {

            const stopped = 'stopped'
            const running = 'running'

            const speed = 1000;
            const $this = $(this);

            const dir = timer.direction;

            const $button = $this.find('button');
            $button.text('loading...');
            $button.prop("disabled", true);

            const $progress = $this.find('.progress-bar');
            const $time = $this.find('div.time');
            const $title = $this.find('div.text');

            const minutes = timer.min;
            const seconds = timer.sec;

            $time.text(`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`)
            $title.text(timer.title);

            const audio = new Audio(getTrack(timer.trackID));
            audio.loop = true;
            audio.preload = 'auto';

            const settings = {
                status: stopped,
                seconds: 0,
                duration: minutes * 60 + seconds,
                interval: null,
                points: 0,
                up: dir === 'up',
            }

            const progressMap = {
                'green': 'bg-success',
                'blue': 'bg-primary',
                'yellow': 'bg-warning',
                'red': 'bg-danger',
            }

            const progress = (percentage) => {

                const percentageRounded = (Math.round((percentage + Number.EPSILON) * 100) / 100);

                if (settings.up) {

                    if (percentageRounded > 95) {
                        if (!$progress.hasClass(progressMap.green)) {
                            Object.values(progressMap).forEach((v) => $progress.removeClass(v));
                            $progress.addClass(progressMap.green);
                        }
                    } else if (percentageRounded > 80) {
                        if (!$progress.hasClass(progressMap.blue)) {
                            Object.values(progressMap).forEach((v) => $progress.removeClass(v));
                            $progress.addClass(progressMap.blue);
                        }
                    } else if (percentageRounded > 40) {
                        if (!$progress.hasClass(progressMap.yellow)) {
                            Object.values(progressMap).forEach((v) => $progress.removeClass(v));
                            $progress.addClass(progressMap.yellow);
                        }
                    } else if (percentageRounded >= 0) {
                        if (!$progress.hasClass(progressMap.red)) {
                            Object.values(progressMap).forEach((v) => $progress.removeClass(v));
                            $progress.addClass(progressMap.red);
                        }
                    }

                } else {

                    if (percentageRounded > 95) {
                        if (!$progress.hasClass(progressMap.red)) {
                            Object.values(progressMap).forEach((v) => $progress.removeClass(v));
                            $progress.addClass(progressMap.red);
                        }
                    } else if (percentageRounded > 80) {
                        if (!$progress.hasClass(progressMap.yellow)) {
                            Object.values(progressMap).forEach((v) => $progress.removeClass(v));
                            $progress.addClass(progressMap.yellow);
                        }
                    } else if (percentageRounded > 40) {
                        if (!$progress.hasClass(progressMap.blue)) {
                            Object.values(progressMap).forEach((v) => $progress.removeClass(v));
                            $progress.addClass(progressMap.blue);
                        }
                    } else if (percentageRounded > 0) {
                        if (!$progress.hasClass(progressMap.green)) {
                            Object.values(progressMap).forEach((v) => $progress.removeClass(v));
                            $progress.addClass(progressMap.green);
                        }
                    }
                }

                $progress.text(`${percentageRounded.toFixed(2)}%`);
                $progress.css('width', `${percentageRounded}%`);
                settings.points = settings.up ? Math.floor(percentage) : 100 - Math.floor(percentage);
            }

            const setOtherButtons = (disabled) => {
                $this.siblings(':not(.played)').find('button').prop("disabled", disabled);
                $('#restart').prop("disabled", disabled);
                $('#settings').prop("disabled", disabled);
            }

            const start = () => {
                settings.status = running

                setOtherButtons(true)
                $button.text('Fertig');
                audio.play();
                progress(0);
                countDown();

            }

            const setPoints = () => {
                const points = (Math.round((settings.points + Number.EPSILON) * 100) / 100);
                $('#point').text(points);
                $('#total-point').text(points + parseInt($('#total-point').text(), 10));
            }

            const stop = () => {
                settings.status = stopped
                audio.pause();
                $this.find('button').prop("disabled", true);
                $this.addClass('played');
                setOtherButtons(false);
                reset();
                setPoints();
            }

            const reset = () => {
                $button.text('Starten');
                clearInterval(settings.interval);
                settings.status = stopped
                settings.seconds = 0;
                setTimeText();
            }

            const setTimeText = () => {
                const delta = settings.duration - settings.seconds;
                const minutes = Math.floor(delta / 60)
                const seconds = delta % 60
                $time.text(`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`)
            }

            const countDown = () => {
                settings.interval = setInterval(() => {
                    if (settings.seconds < settings.duration) {
                        settings.seconds += 1;
                        const percentage = 100 / settings.duration * settings.seconds;

                        setTimeText();

                        progress(percentage);

                    } else {
                        stop()
                    }
                }, speed)
            }




            return new Promise(function (resolve, reject) {
                audio.addEventListener("canplaythrough", (event) => {
                    reset();
                    progress(0);
                    resolve();
                    $button.on('click', () => {
                        if (settings.status === stopped) {
                            start()
                        } else {
                            stop()
                        }
                    });
                }, { once: true });
                audio.load();
            });

        }

        const initPlayer = function () {
            config.isPlaying = false;
            config.point = 0;
            config.totalPoint = 0;
            $('#point').text(config.point);
            $('#total-point').text(config.totalPoint);

            const $musicBox = $('#musicbox');
            $musicBox.empty();

            $('#restart').on('click', function (e, b) {
                $(this).off('click');
                initPlayer();
            });

            Promise.all(getTimers().map((timer, index) => {
                if (timer.enabled === false) {
                    return Promise.resolve();
                }
                const $template = $($("#player").html());
                $template.data('index', index);
                $template.addClass(`index-${index}`);
                $template.appendTo($musicBox);
                return timerTask.call($template, timer);
            })).then(() => {
                getTimers().map((timer, index) => {
                    if (timer.enabled === false) {
                        return;
                    }
                    $(`.index-${index}`).find('button').prop("disabled", false);
                });
            });
        }



        const updateSettings = function () {
            const $container = $('#settingsContainer');
            const timers = getTimers();
            timers.forEach((timer, index) => {
                const $setting = $(`.settings-index-${index}`, $container)
                timer.min = parseInt($('#min', $setting).val()) || timer.min;
                timer.sec = parseInt($('#sec', $setting).val()) || timer.sec;
                timer.title = $('#title', $setting).val();
                timer.direction = $('#type', $setting).val();
                timer.enabled = $('#state', $setting).val() === 'on';
                timer.trackID = $('#track', $setting).val();
            });
            setTimers(timers);

            $('#settingsModal').modal('hide');
            initPlayer();
        }

        const showSettings = function () {
            const $container = $('#settingsContainer');
            $container.empty();

            const $labels = $($('#settingsTemplate').html());
            $('label', $labels).next().remove();
            $labels.removeClass('setting');
            $labels.appendTo($container);

            getTimers().forEach((timer, index) => {
                const $template = $($('#settingsTemplate').html());

                $('label', $template).remove();

                $('#min', $template).val(timer.min);
                $('#sec', $template).val(timer.sec);
                $('#title', $template).val(timer.title);
                $('#type', $template).val(timer.direction);
                $('#state', $template).val(timer.enabled ? 'on' : 'off');
                const $track = $('#track', $template);

                Object.keys(sounds).forEach((key) => {
                    const item = sounds[key];
                    $track.append($('<option>', {
                        value: key,
                        text: item.name
                    }));
                });
                $track.val(timer.trackID);

                $('#play', $template).on('click', function () {
                    if (window.audioPlayer) {
                        window.audioPlayer.pause();
                        window.audioPlayer = null;
                        return;
                    }
                    const trackID = $track.val();
                    window.audioPlayer = new Audio(getTrack(trackID));
                    window.audioPlayer.play();
                });

                $template.data('settings-index', index);
                $template.addClass(`settings-index-${index}`);
                $template.appendTo($container);
            });
            $container.sortable({
                // SortableJS options go here
                // See: (https://github.com/SortableJS/Sortable#options)

                handle: '.setting',
                invertSwap: true,

                onEnd: function (evt) {
                    $('.setting', $container).each(function (index) {
                        const $this = $(this);
                        $this.removeClass(function (index, className) {
                            return (className.match(/\bsettings-index-\S+/g) || []).join(' ');
                        }).addClass(`settings-index-${index}`);
                    });
                }
            })
            $('#settingsModal').modal('show');
        }

        $(function () {

            $('#settings').on('click', showSettings);
            $('#update-settings').on('click', updateSettings);
            document.getElementById('settingsModal').addEventListener('hidden.bs.modal', event => {
                if (window.audioPlayer) {
                    window.audioPlayer.pause();
                    delete window.audioPlayer;
                }
            })
            initPlayer();

        });

    </script>
</body>

</html>
